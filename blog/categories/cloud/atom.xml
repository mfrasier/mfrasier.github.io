<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Cloud | Blog about things]]></title>
  <link href="http://mfrasier.github.io/blog/categories/cloud/atom.xml" rel="self"/>
  <link href="http://mfrasier.github.io/"/>
  <updated>2015-01-07T08:19:09-05:00</updated>
  <id>http://mfrasier.github.io/</id>
  <author>
    <name><![CDATA[Marty Frasier]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Kicking the Tires of coreOS]]></title>
    <link href="http://mfrasier.github.io/blog/2015/01/06/kicking-the-tires-of-coreos/"/>
    <updated>2015-01-06T10:52:05-05:00</updated>
    <id>http://mfrasier.github.io/blog/2015/01/06/kicking-the-tires-of-coreos</id>
    <content type="html"><![CDATA[<p>I&rsquo;m going to try out <a href="http://coreos.com">CoreOS</a> to create a cluster of machines to host an app consisting of docker containers.</p>

<p>CoreOS is a linux distribution designed to run clusters of containers efficiently and securely.  Our application components run in <a href="http://www.docker.com">Docker</a> containers, organized as services.  The distribution also includes etcd, a key/value store for distributed configuration management; and fleet to manage services across clusters.  The machines can be automatically updated with any security fixes and patches.</p>

<p>First, let&rsquo;s create a CloudFormation template we will use to create our stack.  I got a minimal template for CoreOS <a href="https://github.com/xueshanf/coreos-aws-cloudformation/blob/master/aws/cloudformation-template.json">here</a>, adding parameters for VPC subnets and related availability zones.  I also updated the AMI for us-east-1, where I&rsquo;m deploying this cluster, to the most recent stable version of CoreOS.</p>

<!-- more -->


<p><figure class='code'><figcaption><span>coreos-cloudformation-template.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">&amp;ldquo;AWSTemplateFormatVersion&amp;rdquo;:</span> <span class="err">&amp;ldquo;2010-09-09&amp;rdquo;,</span>
</span><span class='line'>  <span class="err">&amp;ldquo;Description&amp;rdquo;:</span> <span class="err">&amp;ldquo;CoreOS</span> <span class="err">on</span> <span class="err">EC2:</span> <span class="err">&lt;a</span> <span class="err">href=</span><span class="nt">&quot;http://coreos.com/docs/running-coreos/cloud-providers/ec2/&quot;</span><span class="err">&gt;http</span><span class="p">:</span><span class="err">//coreos.com/docs/running-coreos/cloud-providers/ec</span><span class="mi">2</span><span class="err">/&lt;/a&gt;&amp;rdquo;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">&amp;ldquo;Mappings&amp;rdquo;</span> <span class="err">:</span> <span class="err">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;RegionMap&amp;rdquo;</span> <span class="err">:</span> <span class="err">{</span>
</span><span class='line'>          <span class="err">&amp;ldquo;ap-northeast-1&amp;rdquo;</span> <span class="err">:</span> <span class="err">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-ab9fbeaa&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span>
</span><span class='line'>          <span class="err">&amp;ldquo;sa-east</span><span class="mi">-1</span><span class="err">&amp;rdquo;</span> <span class="err">:</span>      <span class="p">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-3169c22c&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span>
</span><span class='line'>          <span class="err">&amp;ldquo;ap-southeast</span><span class="mi">-2</span><span class="err">&amp;rdquo;</span> <span class="err">:</span> <span class="p">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-a31f7f99&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span>
</span><span class='line'>          <span class="err">&amp;ldquo;ap-southeast</span><span class="mi">-1</span><span class="err">&amp;rdquo;</span> <span class="err">:</span> <span class="p">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-3e54716c&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span>
</span><span class='line'>          <span class="err">&amp;ldquo;us-east</span><span class="mi">-1</span><span class="err">&amp;rdquo;</span> <span class="err">:</span>      <span class="p">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-b83295d0&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span>
</span><span class='line'>          <span class="err">&amp;ldquo;us-west</span><span class="mi">-2</span><span class="err">&amp;rdquo;</span> <span class="err">:</span>      <span class="p">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-d32462e3&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span>
</span><span class='line'>          <span class="err">&amp;ldquo;us-west</span><span class="mi">-1</span><span class="err">&amp;rdquo;</span> <span class="err">:</span>      <span class="p">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-9b5d53de&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span>
</span><span class='line'>          <span class="err">&amp;ldquo;eu-west</span><span class="mi">-1</span><span class="err">&amp;rdquo;</span> <span class="err">:</span>      <span class="p">{</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;ami-cec912b9&amp;rdquo;</span> <span class="p">}</span>
</span><span class='line'>      <span class="err">}</span>
</span><span class='line'>  <span class="err">},</span>
</span><span class='line'>  <span class="err">&amp;ldquo;Parameters&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>    <span class="err">&amp;ldquo;InstanceType&amp;rdquo;</span> <span class="err">:</span> <span class="err">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;EC2</span> <span class="err">HVM</span> <span class="err">instance</span> <span class="err">type</span> <span class="err">(m3.medium,</span> <span class="err">etc).&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;String&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Default&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;m3.medium&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;AllowedValues&amp;rdquo;</span> <span class="err">:</span> <span class="err">[</span> <span class="err">&amp;ldquo;m3.medium&amp;rdquo;,</span> <span class="err">&amp;ldquo;m3.large&amp;rdquo;,</span> <span class="err">&amp;ldquo;m3.xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;m3.2xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;c3.large&amp;rdquo;,&amp;ldquo;c3.xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;c3.2xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;c3.4xlarge&amp;rdquo;,&amp;ldquo;c3.8xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;cc2.8xlarge&amp;rdquo;,&amp;ldquo;cr1.8xlarge&amp;rdquo;,&amp;ldquo;hi1.4xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;hs1.8xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;i2.xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;i2.2xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;i2.4xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;i2.8xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;r3.large&amp;rdquo;,</span> <span class="err">&amp;ldquo;r3.xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;r3.2xlarge&amp;rdquo;,&amp;ldquo;r3.4xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;r3.8xlarge&amp;rdquo;,</span> <span class="err">&amp;ldquo;t2.micro&amp;rdquo;,</span> <span class="err">&amp;ldquo;t2.small&amp;rdquo;,</span> <span class="err">&amp;ldquo;t2.medium&amp;rdquo;</span> <span class="err">],</span>
</span><span class='line'>      <span class="err">&amp;ldquo;ConstraintDescription&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;Must</span> <span class="err">be</span> <span class="err">a</span> <span class="err">valid</span> <span class="err">EC2</span> <span class="err">HVM</span> <span class="err">instance</span> <span class="err">type.&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;VPCId&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;:</span> <span class="err">&amp;ldquo;ID</span> <span class="err">of</span> <span class="err">VPC</span> <span class="err">hosting</span> <span class="err">cluster&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;AWS::EC2::VPC::Id&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;SubnetIdList&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;:</span> <span class="err">&amp;ldquo;Comma-separated</span> <span class="err">list</span> <span class="err">of</span> <span class="err">VPC</span> <span class="err">Subnet</span> <span class="err">IDs</span> <span class="err">to</span> <span class="err">place</span> <span class="err">instances&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;List&amp;lt;AWS::EC2::Subnet::Id&gt;&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;ClusterSize&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Default&amp;rdquo;:</span> <span class="err">&amp;ldquo;3&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;MinValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;3&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;MaxValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;12&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;:</span> <span class="err">&amp;ldquo;Number</span> <span class="err">of</span> <span class="err">nodes</span> <span class="err">in</span> <span class="err">cluster</span> <span class="err">(3-12).&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;Number&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;DiscoveryURL&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;:</span> <span class="err">&amp;ldquo;An</span> <span class="err">unique</span> <span class="err">etcd</span> <span class="err">cluster</span> <span class="err">discovery</span> <span class="err">URL.</span> <span class="err">Grab</span> <span class="err">a</span> <span class="err">new</span> <span class="err">token</span> <span class="err">from</span> <span class="err">&lt;a</span> <span class="err">href=</span><span class="nt">&quot;https://discovery.etcd.io/new&quot;</span><span class="err">&gt;https</span><span class="p">:</span><span class="err">//discovery.etcd.io/new&lt;/a&gt;&amp;rdquo;</span><span class="p">,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;String&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;AdvertisedIPAddress&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;:</span> <span class="err">&amp;ldquo;Use</span> <span class="err">&amp;lsquo;private&amp;rsquo;</span> <span class="err">if</span> <span class="err">your</span> <span class="err">etcd</span> <span class="err">cluster</span> <span class="err">is</span> <span class="err">within</span> <span class="err">one</span> <span class="err">region</span> <span class="err">or</span> <span class="err">&amp;lsquo;public&amp;rsquo;</span> <span class="err">if</span> <span class="err">it</span> <span class="err">spans</span> <span class="err">regions</span> <span class="err">or</span> <span class="err">cloud</span> <span class="err">providers.&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Default&amp;rdquo;:</span> <span class="err">&amp;ldquo;private&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;AllowedValues&amp;rdquo;:</span> <span class="err">[&amp;ldquo;private&amp;rdquo;,</span> <span class="err">&amp;ldquo;public&amp;rdquo;],</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;String&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;AllowSSHFrom&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;:</span> <span class="err">&amp;ldquo;The</span> <span class="err">net</span> <span class="err">block</span> <span class="err">(CIDR)</span> <span class="err">that</span> <span class="err">SSH</span> <span class="err">is</span> <span class="err">available</span> <span class="err">to.&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Default&amp;rdquo;:</span> <span class="err">&amp;ldquo;0.0.0.0/0&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;String&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;KeyPair&amp;rdquo;</span> <span class="err">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Description&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;The</span> <span class="err">name</span> <span class="err">of</span> <span class="err">an</span> <span class="err">EC2</span> <span class="err">Key</span> <span class="err">Pair</span> <span class="err">to</span> <span class="err">allow</span> <span class="err">SSH</span> <span class="err">access</span> <span class="err">to</span> <span class="err">the</span> <span class="err">instance.&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;String&amp;rdquo;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="err">},</span>
</span><span class='line'>  <span class="err">&amp;ldquo;Resources&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>    <span class="err">&amp;ldquo;CoreOSSecurityGroup&amp;rdquo;:</span> <span class="err">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;AWS::EC2::SecurityGroup&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Properties&amp;rdquo;:</span> <span class="err">{</span>
</span><span class='line'>        <span class="err">&amp;ldquo;GroupDescription&amp;rdquo;:</span> <span class="err">&amp;ldquo;CoreOS</span> <span class="err">SecurityGroup&amp;rdquo;,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;SecurityGroupIngress&amp;rdquo;:</span> <span class="err">[</span>
</span><span class='line'>          <span class="err">{&amp;ldquo;IpProtocol&amp;rdquo;:</span> <span class="err">&amp;ldquo;tcp&amp;rdquo;,</span> <span class="err">&amp;ldquo;FromPort&amp;rdquo;:</span> <span class="err">&amp;ldquo;22&amp;rdquo;,</span> <span class="err">&amp;ldquo;ToPort&amp;rdquo;:</span> <span class="err">&amp;ldquo;22&amp;rdquo;,</span> <span class="err">&amp;ldquo;CidrIp&amp;rdquo;:</span> <span class="err">{&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;AllowSSHFrom&amp;rdquo;</span><span class="p">}</span><span class="err">}</span>
</span><span class='line'>        <span class="err">]</span>
</span><span class='line'>      <span class="err">}</span>
</span><span class='line'>    <span class="err">},</span>
</span><span class='line'>    <span class="err">&amp;ldquo;Ingress</span><span class="mi">4001</span><span class="err">&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;AWS::EC2::SecurityGroupIngress&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Properties&amp;rdquo;:</span> <span class="err">{</span>
</span><span class='line'>        <span class="err">&amp;ldquo;GroupName&amp;rdquo;:</span> <span class="err">{&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;CoreOSSecurityGroup&amp;rdquo;</span><span class="p">}</span><span class="err">,</span> <span class="err">&amp;ldquo;IpProtocol&amp;rdquo;:</span> <span class="err">&amp;ldquo;tcp&amp;rdquo;,</span> <span class="err">&amp;ldquo;FromPort&amp;rdquo;:</span> <span class="err">&amp;ldquo;</span><span class="mi">4001</span><span class="err">&amp;rdquo;,</span> <span class="err">&amp;ldquo;ToPort&amp;rdquo;:</span> <span class="err">&amp;ldquo;</span><span class="mi">4001</span><span class="err">&amp;rdquo;,</span> <span class="err">&amp;ldquo;SourceSecurityGroupId&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>          <span class="err">&amp;ldquo;Fn::GetAtt&amp;rdquo;</span> <span class="err">:</span> <span class="err">[</span> <span class="err">&amp;ldquo;CoreOSSecurityGroup&amp;rdquo;,</span> <span class="err">&amp;ldquo;GroupId&amp;rdquo;</span> <span class="err">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="err">}</span>
</span><span class='line'>    <span class="err">},</span>
</span><span class='line'>    <span class="err">&amp;ldquo;Ingress</span><span class="mi">7001</span><span class="err">&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;AWS::EC2::SecurityGroupIngress&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Properties&amp;rdquo;:</span> <span class="err">{</span>
</span><span class='line'>        <span class="err">&amp;ldquo;GroupName&amp;rdquo;:</span> <span class="err">{&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;CoreOSSecurityGroup&amp;rdquo;</span><span class="p">}</span><span class="err">,</span> <span class="err">&amp;ldquo;IpProtocol&amp;rdquo;:</span> <span class="err">&amp;ldquo;tcp&amp;rdquo;,</span> <span class="err">&amp;ldquo;FromPort&amp;rdquo;:</span> <span class="err">&amp;ldquo;</span><span class="mi">7001</span><span class="err">&amp;rdquo;,</span> <span class="err">&amp;ldquo;ToPort&amp;rdquo;:</span> <span class="err">&amp;ldquo;</span><span class="mi">7001</span><span class="err">&amp;rdquo;,</span> <span class="err">&amp;ldquo;SourceSecurityGroupId&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>          <span class="err">&amp;ldquo;Fn::GetAtt&amp;rdquo;</span> <span class="err">:</span> <span class="err">[</span> <span class="err">&amp;ldquo;CoreOSSecurityGroup&amp;rdquo;,</span> <span class="err">&amp;ldquo;GroupId&amp;rdquo;</span> <span class="err">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="err">}</span>
</span><span class='line'>    <span class="err">},</span>
</span><span class='line'>    <span class="err">&amp;ldquo;CoreOSServerAutoScale&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;AWS::AutoScaling::AutoScalingGroup&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Properties&amp;rdquo;:</span> <span class="err">{</span>
</span><span class='line'>        <span class="err">&amp;ldquo;AvailabilityZones&amp;rdquo;:</span> <span class="err">{&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;AvailabilityZones&amp;rdquo;</span><span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;VPCZoneIdentifier&amp;rdquo;:</span> <span class="p">{</span><span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;SubnetIdList&amp;rdquo;</span><span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;LaunchConfigurationName&amp;rdquo;:</span> <span class="p">{</span><span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;CoreOSServerLaunchConfig&amp;rdquo;</span><span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;MinSize&amp;rdquo;:</span> <span class="err">&amp;ldquo;</span><span class="mi">3</span><span class="err">&amp;rdquo;,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;MaxSize&amp;rdquo;:</span> <span class="err">&amp;ldquo;</span><span class="mi">12</span><span class="err">&amp;rdquo;,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;DesiredCapacity&amp;rdquo;:</span> <span class="p">{</span><span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;ClusterSize&amp;rdquo;</span><span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;Tags&amp;rdquo;:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span><span class="err">&amp;ldquo;Key&amp;rdquo;:</span> <span class="err">&amp;ldquo;Name&amp;rdquo;,</span> <span class="err">&amp;ldquo;Value&amp;rdquo;:</span> <span class="err">{</span> <span class="err">&amp;ldquo;Ref&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;AWS::StackName&amp;rdquo;</span> <span class="p">},</span> <span class="err">&amp;ldquo;PropagateAtLaunch&amp;rdquo;:</span> <span class="kc">true</span><span class="err">}</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="err">}</span>
</span><span class='line'>    <span class="err">},</span>
</span><span class='line'>    <span class="err">&amp;ldquo;CoreOSServerLaunchConfig&amp;rdquo;:</span> <span class="p">{</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Type&amp;rdquo;:</span> <span class="err">&amp;ldquo;AWS::AutoScaling::LaunchConfiguration&amp;rdquo;,</span>
</span><span class='line'>      <span class="err">&amp;ldquo;Properties&amp;rdquo;:</span> <span class="err">{</span>
</span><span class='line'>        <span class="err">&amp;ldquo;ImageId&amp;rdquo;</span> <span class="err">:</span> <span class="err">{</span> <span class="err">&amp;ldquo;Fn::FindInMap&amp;rdquo;</span> <span class="err">:</span> <span class="err">[</span> <span class="err">&amp;ldquo;RegionMap&amp;rdquo;,</span> <span class="err">{</span> <span class="err">&amp;ldquo;Ref&amp;rdquo;</span> <span class="err">:</span> <span class="err">&amp;ldquo;AWS::Region&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span> <span class="err">&amp;ldquo;AMI&amp;rdquo;</span> <span class="err">]},</span>
</span><span class='line'>        <span class="err">&amp;ldquo;InstanceType&amp;rdquo;:</span> <span class="p">{</span><span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;InstanceType&amp;rdquo;</span><span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;KeyName&amp;rdquo;:</span> <span class="p">{</span><span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;KeyPair&amp;rdquo;</span><span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;SecurityGroups&amp;rdquo;:</span> <span class="p">[{</span><span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;CoreOSSecurityGroup&amp;rdquo;</span><span class="p">}]</span><span class="err">,</span>
</span><span class='line'>        <span class="err">&amp;ldquo;UserData&amp;rdquo;</span> <span class="err">:</span> <span class="p">{</span> <span class="err">&amp;ldquo;Fn::Base64&amp;rdquo;:</span>
</span><span class='line'>          <span class="err">{</span> <span class="err">&amp;ldquo;Fn::Join&amp;rdquo;:</span> <span class="err">[</span> <span class="err">&amp;ldquo;&amp;rdquo;,</span> <span class="err">[</span>
</span><span class='line'>            <span class="err">&amp;ldquo;#cloud-config\n\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;coreos:\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>  <span class="err">etcd:\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>    <span class="err">discovery:</span> <span class="err">&amp;rdquo;,</span> <span class="err">{</span> <span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;DiscoveryURL&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span> <span class="err">&amp;ldquo;\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>    <span class="err">addr:</span> <span class="err">$&amp;rdquo;,</span> <span class="p">{</span> <span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;AdvertisedIPAddress&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span> <span class="err">&amp;ldquo;&lt;em&gt;ipv</span><span class="mi">4</span><span class="err">:</span><span class="mi">4001</span><span class="err">\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>    <span class="err">peer-addr:</span> <span class="err">$&amp;rdquo;,</span> <span class="p">{</span> <span class="err">&amp;ldquo;Ref&amp;rdquo;:</span> <span class="err">&amp;ldquo;AdvertisedIPAddress&amp;rdquo;</span> <span class="p">}</span><span class="err">,</span> <span class="err">&amp;ldquo;&lt;/em&gt;ipv</span><span class="mi">4</span><span class="err">:</span><span class="mi">7001</span><span class="err">\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>  <span class="err">units:\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>    <span class="err">-</span> <span class="err">name:</span> <span class="err">etcd.service\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>      <span class="err">command:</span> <span class="err">start\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>    <span class="err">-</span> <span class="err">name:</span> <span class="err">fleet.service\n&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;</span>      <span class="err">command:</span> <span class="err">start\n&amp;rdquo;</span>
</span><span class='line'>            <span class="err">]</span> <span class="err">]</span>
</span><span class='line'>          <span class="err">}</span>
</span><span class='line'>        <span class="err">}</span>
</span><span class='line'>      <span class="err">}</span>
</span><span class='line'>    <span class="err">}</span>
</span><span class='line'>  <span class="err">}</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The most interesting part is probably the UserData value for the CoreOSServerLaunchConfig resource, which configures the etcd service and ensures the etcd and fleet services are started at boot time.  We&rsquo;ll get back to those later.</p>

<p><code>aws cli cloudformation create-stack</code> can accept JSON-formatted command specification.  It has a template generator command switch <code>&ndash;generate-cli-skeleton</code>, which will generate an empty json file template with parameter placeholders.  It contains some mutually exclusive keys so you&rsquo;ll need to remove some keys.</p>

<p>I ran the command, saved the output as a file, and modified it to my needs. I populated the DiscveryURL parameter with a new unique key from from <a href="https://discovery.etcd.io/new.">https://discovery.etcd.io/new.</a></p>

<p><figure class='code'><figcaption><span>aws-cfn-cli-skeleton.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="err">&amp;ldquo;StackName&amp;rdquo;:</span> <span class="err">&amp;ldquo;coreos-test&amp;rdquo;,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;Parameters&amp;rdquo;:</span> <span class="err">[</span>
</span><span class='line'>        <span class="err">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;InstanceType&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;t2.small&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;AvailabilityZones&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;us-east-1e&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;SubnetIdList&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;subnet-979a58bc&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;ClusterSize&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;3&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;DiscoveryURL&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;&lt;a</span> <span class="err">href=</span><span class="nt">&quot;https://discovery.etcd.io/87a8b544cf5hhf7436d601273c1d22d8&quot;</span><span class="err">&gt;https</span><span class="p">:</span><span class="err">//discovery.etcd.io/</span><span class="mi">87</span><span class="err">a</span><span class="mi">8</span><span class="err">b</span><span class="mi">544</span><span class="err">cf</span><span class="mi">5</span><span class="err">hhf</span><span class="mi">7436</span><span class="err">d</span><span class="mi">601273</span><span class="err">c</span><span class="mi">1</span><span class="err">d</span><span class="mi">22</span><span class="err">d</span><span class="mi">8</span><span class="err">&lt;/a&gt;&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;KeyPair&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;mfrasier_key&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;AdvertisedIPAddress&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;private&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span><span class="err">,</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterKey&amp;rdquo;:</span> <span class="err">&amp;ldquo;AllowSSHFrom&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;ParameterValue&amp;rdquo;:</span> <span class="err">&amp;ldquo;0.0.0.0/0&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="err">],</span>
</span><span class='line'>    <span class="err">&amp;ldquo;DisableRollback&amp;rdquo;:</span> <span class="kc">true</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;TimeoutInMinutes&amp;rdquo;:</span> <span class="mi">5</span><span class="err">,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;Tags&amp;rdquo;:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="err">&amp;ldquo;Key&amp;rdquo;:</span> <span class="err">&amp;ldquo;Environment&amp;rdquo;,</span>
</span><span class='line'>            <span class="err">&amp;ldquo;Value&amp;rdquo;:</span> <span class="err">&amp;ldquo;test&amp;rdquo;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<h3>create AWS cloudformation stack</h3>

<p>Create a new stack consisting of three coreOS instances using a command like the following:</p>

<pre><code> aws cloudformation create-stack \
   --cli-input-json file://aws-cfn-cli-skeleton.json \
   --template-body file://coreos-cloudformation-template.json
</code></pre>

<h3>interact with stack instances</h3>

<h4>start ssh-agent and add private key</h4>

<p>This uses ssh-agent to provide your key when necessary.  The ssh -A comand forwards the agent to the hosts so you can ssh between hosts (fleetctl needs it).  Use the key you specified when creating your instances.</p>

<pre><code>$ eval $(ssh-agent)
Agent pid 8456
$ ssh-add my_key.pem 
Identity added: my_key.pem (my_key.pem)
</code></pre>

<h4>login to instances, at least two, in separate terminal windows</h4>

<pre><code>ssh -A core@&lt;public-ip-address-1&gt;
ssh -A core@&lt;public-ip-address-2&gt;
ssh -A core@&lt;public-ip-address-3&gt;
</code></pre>

<p>The username is core.  You obviously need to allow SSH traffic into your new instances from you management workstation using the AWS security group rules.</p>

<h4>check status of etcd service</h4>

<p>Be sure to allow the instances to chat with each other on TCP ports 4001 and 7001.  At the start of the output below I hadn&rsquo;t yet edited my security group to allow that communication.  Once I made the change, one host became the leader and they added peers.</p>

<pre><code>systemctl -l status etcd.service
* etcd.service - etcd
   Loaded: loaded (/usr/lib64/systemd/system/etcd.service; static)
  Drop-In: /run/systemd/system/etcd.service.d
           └─10-oem.conf, 20-cloudinit.conf
   Active: active (running) since Tue 2015-01-06 21:36:55 UTC; 45s ago
 Main PID: 781 (etcd)
   CGroup: /system.slice/etcd.service
           └─781 /usr/bin/etcd

Jan 06 21:37:07 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:07.550 INFO      | 33edd7a8e0a844648df3f5dd2a4b6fbd attempted to join via 10.0.1.251:7001 failed: fail checking join version: Client Internal Error (Get http://10.0.1.251:7001/version: dial tcp 10.0.1.251:7001: i/o timeout)
Jan 06 21:37:07 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:07.550 INFO      | 33edd7a8e0a844648df3f5dd2a4b6fbd is unable to join the cluster using any of the peers [10.0.1.249:7001 10.0.1.251:7001] at 1th time. Retrying in 2.8 seconds
Jan 06 21:37:09 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:09.553 INFO      | Send Join Request to http://10.0.1.249:7001/join
Jan 06 21:37:09 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:09.564 INFO      | 33edd7a8e0a844648df3f5dd2a4b6fbd joined the cluster via peer 10.0.1.249:7001
Jan 06 21:37:09 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:09.601 INFO      | etcd server [name 33edd7a8e0a844648df3f5dd2a4b6fbd, listen on :4001, advertised url http://10.0.1.250:4001]
Jan 06 21:37:09 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:09.602 INFO      | peer server [name 33edd7a8e0a844648df3f5dd2a4b6fbd, listen on :7001, advertised url http://10.0.1.250:7001]
Jan 06 21:37:09 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:09.603 INFO      | 33edd7a8e0a844648df3f5dd2a4b6fbd starting in peer mode
Jan 06 21:37:09 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:09.603 INFO      | 33edd7a8e0a844648df3f5dd2a4b6fbd: state changed from 'initialized' to 'follower'.
Jan 06 21:37:09 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:09.669 INFO      | 33edd7a8e0a844648df3f5dd2a4b6fbd: peer added: '87b320be82a54d34851b253f61db489c'
Jan 06 21:37:12 ip-10-0-1-250.ec2.internal etcd[781]: [etcd] Jan  6 21:37:12.218 INFO      | 33edd7a8e0a844648df3f5dd2a4b6fbd: peer added: '50aed17347a1456e85279f8dda41e663'
</code></pre>

<h4>test etcd distributed key service</h4>

<p>see <a href="https://coreos.com/docs/quickstart/">https://coreos.com/docs/quickstart/</a> as these steps are basically copied from that.</p>

<p>Set a key on one host</p>

<pre><code>core@ip-10-0-1-249 ~ $ curl -L http://localhost:4001/v1/keys/message -d value="hello coreOS"
{"action":"set","key":"/message","value":"hello coreOS","newKey":true,"index":336}
</code></pre>

<p>Query the key from another host</p>

<pre><code>core@ip-10-0-1-250 ~ $ curl -L http://localhost:4001/v1/keys/message
{"action":"get","key":"/message","value":"hello coreOS","index":349}
</code></pre>

<h4>list machines and service units controlled by fleet</h4>

<pre><code>core@ip-10-0-1-249 ~ $ fleetctl list-machines
MACHINE         IP              METADATA
33edd7a8...     10.0.1.250      -
50aed173...     10.0.1.251      -
87b320be...     10.0.1.249      -

core@ip-10-0-1-249 ~ $ fleetctl list-units
UNIT    MACHINE ACTIVE  SUB

core@ip-10-0-1-249 ~ $ fleetctl list-unit-files
UNIT    HASH    DSTATE  STATE   TARGET
</code></pre>

<p>Good, we have some machines but no fleet controlled units yet.  Let&rsquo;s create a service.</p>

<h3>Docker container services</h3>

<h4>Create a docker container nano-service</h4>

<p>Create file ~/hello.service</p>

<p><figure class='code'><figcaption><span>hello.service </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[Unit]</span>
</span><span class='line'><span class="na">Description</span><span class="o">=</span><span class="s">My Service</span>
</span><span class='line'><span class="na">After</span><span class="o">=</span><span class="s">docker.service&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="k">[Service]</span>
</span><span class='line'><span class="na">TimeoutStartSec</span><span class="o">=</span><span class="s">0</span>
</span><span class='line'><span class="na">ExecStartPre</span><span class="o">=</span><span class="s">-/usr/bin/docker kill hello</span>
</span><span class='line'><span class="na">ExecStartPre</span><span class="o">=</span><span class="s">-/usr/bin/docker rm hello</span>
</span><span class='line'><span class="na">ExecStartPre</span><span class="o">=</span><span class="s">/usr/bin/docker pull busybox</span>
</span><span class='line'><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/docker run &amp;ndash;name hello busybox /bin/sh -c &amp;ldquo;while true; do echo Hello World; sleep 1; done&amp;rdquo;</span>
</span><span class='line'><span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/bin/docker stop hello</span>
</span></code></pre></td></tr></table></div></figure></p>

<h4>load and start the unit</h4>

<pre><code>core@ip-10-0-1-249 ~ $ fleetctl load hello.service
Unit hello.service loaded on 33edd7a8.../10.0.1.250

core@ip-10-0-1-249 ~ $ fleetctl start hello.service
Unit hello.service launched on 33edd7a8.../10.0.1.250
</code></pre>

<p>You can see from the output the service was loaded and installed on a host other than the one we&rsquo;re logged into.  View cluster services with fleetctl stats &lt;name.service></p>

<pre><code>core@ip-10-0-1-249 ~ $ fleetctl list-units
UNIT            MACHINE                 ACTIVE  SUB
hello.service   33edd7a8.../10.0.1.250  active  running

core@ip-10-0-1-249 ~ $ fleetctl status hello.service
● hello.service - My Service
   Loaded: loaded (/run/fleet/units/hello.service; linked-runtime)
   Active: active (running) since Tue 2015-01-06 22:19:17 UTC; 1min 35s ago
  Process: 3872 ExecStartPre=/usr/bin/docker pull busybox (code=exited, status=0/SUCCESS)
  Process: 3860 ExecStartPre=/usr/bin/docker rm hello (code=exited, status=1/FAILURE)
  Process: 3796 ExecStartPre=/usr/bin/docker kill hello (code=exited, status=1/FAILURE)
 Main PID: 3917 (docker)
   CGroup: /system.slice/hello.service
           └─3917 /usr/bin/docker run --name hello busybox /bin/sh -c while true; do echo Hello World; sleep 1; done

Jan 06 22:20:43 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:44 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:45 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:46 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:47 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:48 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:49 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:50 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:51 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:20:52 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
</code></pre>

<p>Notice that two of the ExecStatPre tasks exited with failure.  Oh my, what has happened?  Those are the docker rm and kill commands which failed because the container named hello hadn&rsquo;t been created yet.  Those commands are executed to ensure we create a new container upon service start and it&rsquo;s ok if they fail with nothing to do.</p>

<p>Some container log lines are displayed also.</p>

<h4>inspect docker images and containers</h4>

<p>We can look on the host where our service was installed to verify it has docker image(s) and running container named hello.</p>

<pre><code>core@ip-10-0-1-249 ~ $ ssh  ip-10-0-1-250 docker images
The authenticity of host 'ip-10-0-1-250 (10.0.1.250)' can't be established.
ED25519 key fingerprint is 8c:2d:b0:8d:08:b5:b2:6b:54:bb:8a:49:81:fd:a1:70.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'ip-10-0-1-250,10.0.1.250' (ED25519) to the list of known hosts.

REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
busybox             buildroot-2014.02   4986bf8c1536        6 days ago          2.433 MB
busybox             latest              4986bf8c1536        6 days ago          2.433 MB

core@ip-10-0-1-249 ~ $ ssh  ip-10-0-1-250 docker ps    
CONTAINER ID        IMAGE                       COMMAND                CREATED             STATUS              PORTS               NAMES
8c96226a4c0e        busybox:buildroot-2014.02   "/bin/sh -c 'while t   8 minutes ago       Up 8 minutes                            hello 
</code></pre>

<p>Or, looks like we can use fleetclt to ssh to other machines.  We can use the machine id reported by fleetctl list-machines or list-units.</p>

<pre><code>core@ip-10-0-1-249 ~ $ fleetctl list-units
UNIT            MACHINE                 ACTIVE  SUB
hello.service   33edd7a8.../10.0.1.250  active  running

core@ip-10-0-1-249 ~ $ fleetctl ssh 33edd7a8 docker ps
CONTAINER ID        IMAGE                       COMMAND                CREATED             STATUS              PORTS               NAMES
8c96226a4c0e        busybox:buildroot-2014.02   "/bin/sh -c 'while t   11 minutes ago      Up 11 minutes                           hello
</code></pre>

<p>super cool!</p>

<h4>stop hello.service</h4>

<p>Stop the service.</p>

<pre><code>core@ip-10-0-1-249 ~ $ fleetctl stop hello.service
Unit hello.service loaded on 33edd7a8.../10.0.1.250

core@ip-10-0-1-249 ~ $ fleetctl status hello.service
● hello.service - My Service
   Loaded: loaded (/run/fleet/units/hello.service; linked-runtime)
   Active: failed (Result: exit-code) since Tue 2015-01-06 22:42:36 UTC; 2s ago
  Process: 5601 ExecStop=/usr/bin/docker stop hello (code=exited, status=0/SUCCESS)
  Process: 3917 ExecStart=/usr/bin/docker run --name hello busybox /bin/sh -c while true; do echo Hello World; sleep 1; done (code=exited, status=255)
  Process: 3872 ExecStartPre=/usr/bin/docker pull busybox (code=exited, status=0/SUCCESS)
  Process: 3860 ExecStartPre=/usr/bin/docker rm hello (code=exited, status=1/FAILURE)
  Process: 3796 ExecStartPre=/usr/bin/docker kill hello (code=exited, status=1/FAILURE)
 Main PID: 3917 (code=exited, status=255)

Jan 06 22:42:30 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:42:31 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:42:32 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:42:33 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:42:34 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:42:35 ip-10-0-1-250.ec2.internal docker[3917]: Hello World
Jan 06 22:42:36 ip-10-0-1-250.ec2.internal docker[5601]: hello
Jan 06 22:42:36 ip-10-0-1-250.ec2.internal systemd[1]: hello.service: main process exited, code=exited, status=255/n/a
Jan 06 22:42:36 ip-10-0-1-250.ec2.internal systemd[1]: Stopped My Service.
Jan 06 22:42:36 ip-10-0-1-250.ec2.internal systemd[1]: Unit hello.service entered failed state.
</code></pre>

<h4>restart hello.service</h4>

<p>The hello.service unit is still loaded; we&rsquo;ll restart it.  This time the ExecStartPre tasks removing the previous container should succeed.</p>

<pre><code>core@ip-10-0-1-249 ~ $ fleetctl start hello.service
Unit hello.service launched on 33edd7a8.../10.0.1.250
core@ip-10-0-1-249 ~ $ 
core@ip-10-0-1-249 ~ $ fleetctl status hello.service
● hello.service - My Service
   Loaded: loaded (/run/fleet/units/hello.service; linked-runtime)
   Active: active (running) since Tue 2015-01-06 22:43:47 UTC; 2s ago
  Process: 5601 ExecStop=/usr/bin/docker stop hello (code=exited, status=0/SUCCESS)
  Process: 5659 ExecStartPre=/usr/bin/docker pull busybox (code=exited, status=0/SUCCESS)
  Process: 5649 ExecStartPre=/usr/bin/docker rm hello (code=exited, status=0/SUCCESS)
  Process: 5641 ExecStartPre=/usr/bin/docker kill hello (code=exited, status=0/SUCCESS)
 Main PID: 5670 (docker)
   CGroup: /system.slice/hello.service
           └─5670 /usr/bin/docker run --name hello busybox /bin/sh -c while true; do echo Hello World; sleep 1; done

Jan 06 22:43:45 ip-10-0-1-250.ec2.internal systemd[1]: Starting My Service...
Jan 06 22:43:46 ip-10-0-1-250.ec2.internal docker[5641]: hello
Jan 06 22:43:46 ip-10-0-1-250.ec2.internal docker[5649]: hello
Jan 06 22:43:46 ip-10-0-1-250.ec2.internal docker[5659]: Pulling repository busybox
Jan 06 22:43:47 ip-10-0-1-250.ec2.internal docker[5659]: Status: Image is up to date for busybox:latest
Jan 06 22:43:47 ip-10-0-1-250.ec2.internal systemd[1]: Started My Service.
Jan 06 22:43:47 ip-10-0-1-250.ec2.internal docker[5670]: Hello World
Jan 06 22:43:48 ip-10-0-1-250.ec2.internal docker[5670]: Hello World
Jan 06 22:43:49 ip-10-0-1-250.ec2.internal docker[5670]: Hello World
</code></pre>

<p>That&rsquo;s the simple quickstart tour of coreOS, etcd, and mantaing services with fleet on an Amazon AWS cluster.  I think the next step is to define some more useful, multi-tiered, services.  We&rsquo;ll need to define the relationships betwen the services, configurations, etc.  Let&rsquo;s use etcd!</p>

<h4>a bonus service</h4>

<p>Here&rsquo;s the beginning of a private docker registry service.</p>

<p><figure class='code'><figcaption><span>registry.service </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="err">core@ip-10-0-1-249</span> <span class="err">~</span> <span class="err">$</span> <span class="err">cat</span> <span class="err">registry.service</span>
</span><span class='line'><span class="k">[Unit]</span>
</span><span class='line'><span class="na">Description</span><span class="o">=</span><span class="s">My Registry Service</span>
</span><span class='line'><span class="na">After</span><span class="o">=</span><span class="s">docker.service&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="k">[Service]</span>
</span><span class='line'><span class="na">TimeoutStartSec</span><span class="o">=</span><span class="s">0</span>
</span><span class='line'><span class="na">ExecStartPre</span><span class="o">=</span><span class="s">-/usr/bin/docker kill registry</span>
</span><span class='line'><span class="na">ExecStartPre</span><span class="o">=</span><span class="s">-/usr/bin/docker rm registry</span>
</span><span class='line'><span class="na">ExecStartPre</span><span class="o">=</span><span class="s">/usr/bin/docker pull registry</span>
</span><span class='line'><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/docker run &amp;ndash;name registry registry /bin/sh -c &amp;ldquo;while true; do echo Hello Registry; sleep 1; done&amp;rdquo;</span>
</span><span class='line'><span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/bin/docker stop registry</span>
</span></code></pre></td></tr></table></div></figure></p>
]]></content>
  </entry>
  
</feed>
